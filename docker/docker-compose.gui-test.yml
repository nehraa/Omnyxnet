# =============================================================================
# Docker Compose - 5-Node Network for GUI Testing
# =============================================================================
# Sets up a 5-node mesh network optimized for desktop GUI testing with:
# - Bootstrap node (node1) on standard ports for GUI connection
# - 4 additional nodes for peer-to-peer testing
# - Proper health checks and dependencies
# - mDNS for automatic peer discovery
#
# Usage:
#   docker-compose -f docker/docker-compose.gui-test.yml up -d
#   docker-compose -f docker/docker-compose.gui-test.yml logs -f
#   docker-compose -f docker/docker-compose.gui-test.yml down
#
# GUI Connection:
#   Connect desktop_app_kivy.py to localhost:8080 (node1)
#   Node1 will auto-discover nodes 2-5 via mDNS
#
# Get Node Multiaddrs:
#   docker-compose -f docker/docker-compose.gui-test.yml logs node1 | grep "multiaddr"
# =============================================================================

services:
  # Node 1 - Bootstrap node for GUI connection
  node1:
    build:
      context: ../go
      dockerfile: Dockerfile
    container_name: wgt-gui-node1
    hostname: node1
    command: >
      ./go-node 
      -node-id=1 
      -capnp-addr=:8080 
      -libp2p=true 
      -libp2p-port=9081
      -mdns=true
      -local
    ports:
      - "8080:8080"   # Cap'n Proto RPC - Connect desktop GUI here
      - "9081:9081"   # libp2p P2P port
    networks:
      wgt-gui-net:
        ipv4_address: 172.30.0.10
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8080"]
      interval: 5s
      timeout: 5s
      retries: 3
    environment:
      - NODE_ID=1
      - NODE_ROLE=bootstrap
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Node 2 - Worker node
  node2:
    build:
      context: ../go
      dockerfile: Dockerfile
    container_name: wgt-gui-node2
    hostname: node2
    command: >
      ./go-node 
      -node-id=2 
      -capnp-addr=:8080 
      -libp2p=true 
      -libp2p-port=9082
      -mdns=true
      -local
    ports:
      - "8081:8080"
      - "9082:9082"
    networks:
      wgt-gui-net:
        ipv4_address: 172.30.0.11
    depends_on:
      node1:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8080"]
      interval: 5s
      timeout: 5s
      retries: 3
    environment:
      - NODE_ID=2
      - NODE_ROLE=worker
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Node 3 - Worker node
  node3:
    build:
      context: ../go
      dockerfile: Dockerfile
    container_name: wgt-gui-node3
    hostname: node3
    command: >
      ./go-node 
      -node-id=3 
      -capnp-addr=:8080 
      -libp2p=true 
      -libp2p-port=9083
      -mdns=true
      -local
    ports:
      - "8082:8080"
      - "9083:9083"
    networks:
      wgt-gui-net:
        ipv4_address: 172.30.0.12
    depends_on:
      node1:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8080"]
      interval: 5s
      timeout: 5s
      retries: 3
    environment:
      - NODE_ID=3
      - NODE_ROLE=worker
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Node 4 - Worker node
  node4:
    build:
      context: ../go
      dockerfile: Dockerfile
    container_name: wgt-gui-node4
    hostname: node4
    command: >
      ./go-node 
      -node-id=4 
      -capnp-addr=:8080 
      -libp2p=true 
      -libp2p-port=9084
      -mdns=true
      -local
    ports:
      - "8083:8080"
      - "9084:9084"
    networks:
      wgt-gui-net:
        ipv4_address: 172.30.0.13
    depends_on:
      node1:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8080"]
      interval: 5s
      timeout: 5s
      retries: 3
    environment:
      - NODE_ID=4
      - NODE_ROLE=worker
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Node 5 - Worker node
  node5:
    build:
      context: ../go
      dockerfile: Dockerfile
    container_name: wgt-gui-node5
    hostname: node5
    command: >
      ./go-node 
      -node-id=5 
      -capnp-addr=:8080 
      -libp2p=true 
      -libp2p-port=9085
      -mdns=true
      -local
    ports:
      - "8084:8080"
      - "9085:9085"
    networks:
      wgt-gui-net:
        ipv4_address: 172.30.0.14
    depends_on:
      node1:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "8080"]
      interval: 5s
      timeout: 5s
      retries: 3
    environment:
      - NODE_ID=5
      - NODE_ROLE=worker
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  wgt-gui-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/16
